---
id: 4650
title: Esri Web AppBuilder 2.4, Empty Basemap Gallery
date: 2017-04-10T20:08:37-05:00
author: Matt
layout: post
guid: http://maprantala.com/?p=4650
permalink: /2017/04/10/esri-web-appbuilder-2-4-empty-basemap-gallery/
categories:
  - ESRI
  - JavaScript
  - Web AppBuilder
tags:
  - appendDeployVersion
  - Basemap Gallery
  - Bugs
  - deployversion
  - env.js
  - JavaScript
  - Web Appbuilder
---
I recently downloaded Web AppBuilder 2.4, Developer&#8217;s Edition and built a quick & dirty app. For some reason, it worked fine in Web AppBuilder but once I deployed it, no basemaps would show in the B[aseman Gallery widget](http://doc.arcgis.com/en/web-appbuilder/create-apps/widget-basemap.htm), it would just spin, spin, spin.

[<img class="alignnone wp-image-4651" src="https://i2.wp.com/maprantala.com/wp-content/uploads/2017/04/BasemapGallery.png?resize=256%2C365" alt="" width="256" height="365" data-recalc-dims="1" />](https://i2.wp.com/maprantala.com/wp-content/uploads/2017/04/BasemapGallery.png)

Digging around, I found some [old posts](https://geonet.esri.com/thread/118906) where users were experiencing similar problems but none of the solution resulted in a great solution. I was able to get it to work by listing the basemaps individually in the config_BasemapGallery.json file but I that was more of a work-around. Notice in the thumbnailUrl, I have to put the full path to the thumbnails. Note that for brevity&#8217;s sake, I&#8217;m only showing one of the basemaps in this sample.

<pre>{
  "basemapGallery": {
    "showArcGISBasemaps": true,
    "basemaps": [{
      "layers": [{"url": "http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}],
      "title": "Imagery",
      "thumbnailUrl": "http://&lt;org&gt;.maps.arcgis.com/sharing/rest/content/items/&lt;id&gt;/info/thumbnail/tempimagery.jpg",
      "spatialReference": {
         "wkid": "102100"
      }
     }]
   }
}</pre>

Eventually, I started comparing the requests generated by the version in the development version and the one in production and tracked the problem down to this POST request in production, which was returning a 400 Bad Request error:

<pre>http://&lt;server&gt;/proxy/proxy.ashx?https://&lt;org&gt;.maps.arcgis.com/sharing/rest/search&wab_dv=2.4
</pre>

To this one in dev:

<pre>https://&lt;org&gt;.maps.arcgis.com/sharing/rest/search</pre>

I stripped off the &#8220;&wab_dv=2.4&#8221; parameter from the production request and Boom! it worked. So I now knew what was causing the problem. Just had to figure out why it was occurring. I had actually already seen part of the answer while digging around in **env.js** while looking for a way to test my changes without having to clear my cache or remember to use an Incognito session. On line 81 of **env.js**, there is this variable, **deployVersion** which is set to 2.4.

[<img class="alignnone size-full wp-image-4653" src="https://i2.wp.com/maprantala.com/wp-content/uploads/2017/04/deployVersion.png?resize=596%2C82" alt="" width="596" height="82" data-recalc-dims="1" />](https://i2.wp.com/maprantala.com/wp-content/uploads/2017/04/deployVersion.png)  
I had recently worked on a solution that involved appending a time stamp onto scripts we were loading so I was familiar with what is going on&#8211;the code was appending a version onto the call so that if you change the **deployVersion**, the browser would load a new version of the code. The **appendDeployVersion** function on line 307 of **env.js** was doing the append. Notice the **if** statement on line 312, it checks for &#8220;?&#8221; in the url. If it finds one, it appends &#8220;**&**wab_dv=&#8221; and the version, otherwise it appends &#8220;**?**wab_dv=&#8221; and the version&#8211;the difference being the &#8220;&&#8221; vs &#8220;?&#8221;. A question mark is used before the first parameter in an URL, each additional parameter is separated by a ampersand (&) so that logic makes sense.

[<img class="alignnone size-full wp-image-4654" src="https://i2.wp.com/maprantala.com/wp-content/uploads/2017/04/IfStatement.png?resize=755%2C196" alt="" width="755" height="196" data-recalc-dims="1" />](https://i2.wp.com/maprantala.com/wp-content/uploads/2017/04/IfStatement.png)

However, the monkey wrench is that I&#8217;m using a proxy, so my URL has a question mark related to the proxy:

<pre>http://&lt;server&gt;/proxy/proxy.ashx<strong>?</strong>https://&lt;org&gt;.maps.arcgis.com/sharing/rest/search&wab_dv=2.4
</pre>

So the code was dutifully appending an ampersand and the version parameter &#8220;&wab_dv=2.4&#8221; to my URL so the proxy would be requesting:

<pre>https://&lt;org&gt;.maps.arcgis.com/sharing/rest/search&wab_dv=2.4
</pre>

when it should have been requesting:

<pre>https://&lt;org&gt;.maps.arcgis.com/sharing/rest/search?wab_dv=2.4
</pre>

Once I had determined the problem (99% of the battle), I was able to quickly put in a patch that works for my instance. This patch isn&#8217;t a great one that Esri should use but it solves it in my case. I just added logic so that it would ignore proxy-related question marks:

[<img class="alignnone size-full wp-image-4655" src="https://i0.wp.com/maprantala.com/wp-content/uploads/2017/04/solution.png?resize=764%2C214" alt="" width="764" height="214" data-recalc-dims="1" />](https://i0.wp.com/maprantala.com/wp-content/uploads/2017/04/solution.png)

<pre>function appendDeployVersion(url){
    if(/^http(s)?:\/\//.test(url) || /^\/proxy\.js/.test(url) || /^\/\//.test(url)){
      return url;
    }

	var proxyURL = url.toLowerCase().replace(".ashx?","");
    if(proxyURL.indexOf('?') &gt; -1){
      url = url + '&wab_dv=' + deployVersion;
    }else{
      url = url + '?wab_dv=' + deployVersion;
    }
    return url;
  }
</pre>

And voila! my Web AppBuilder now had all the basemaps options a mapineer could hope for:  
[<img class="alignnone size-full wp-image-4656" src="https://i0.wp.com/maprantala.com/wp-content/uploads/2017/04/BaemapsAplenty.png?resize=366%2C487" alt="" width="366" height="487" data-recalc-dims="1" />](https://i0.wp.com/maprantala.com/wp-content/uploads/2017/04/BaemapsAplenty.png)